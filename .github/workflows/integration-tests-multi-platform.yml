# Multi-Platform Integration Tests Pipeline
#
# This workflow runs integration tests on multiple platforms (Windows, Ubuntu, macOS).
# It uses a single-process approach where all installation and test steps run
# sequentially in the same VS Code instance, solving Windows PATH propagation issues.
#
# Trigger behavior:
# - PRs to develop: Ubuntu-only by default (fast CI)
# - PRs to main/pre-release: All platforms (Ubuntu, Windows, macOS)
# - PRs with 'test-all-platforms' label: All platforms (Ubuntu, Windows, macOS)
# - Push to main/pre-release (releases): All platforms
# - Manual dispatch: All platforms
#
# Architecture:
# 1. Stage 1: Determine which platforms to test
# 2. Stage 2: Build VSIX on Ubuntu
# 3. Stage 3: Parallel platform jobs that:
#    - Install VS Code
#    - Install the VSIX extension
#    - Run a single combined test that sequentially:
#      a) Installs package manager (winget/apt/brew)
#      b) Installs host packages (cmake, ninja, gperf, etc.)
#      c) Runs workspace tests
#    - All steps execute in the SAME process, so PATH refresh works immediately

name: Multi-Platform Integration Tests

on:
  push:
    branches: [main, pre-release]
  pull_request:
    branches: [main, pre-release, develop]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to run tests on"
        required: false
        type: string
        default: ""

permissions:
  contents: read

jobs:
  # Stage 1: Determine which platforms to test
  determine-platforms:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Determine platform matrix
        id: set-matrix
        run: |
          # All platforms: push to main/pre-release, manual dispatch, or PR with label
          ALL_PLATFORMS='{"include":[{"platform":"ubuntu","os":"ubuntu-latest","xvfb":"xvfb-run -a ","zephyr_base":"/tmp/zephyr","setup_cmd":"sudo apt-get update && sudo apt-get install -y xvfb libgtk-3-0 libgbm1 libnss3 libasound2t64"},{"platform":"windows","os":"windows-latest","xvfb":"","zephyr_base":"D:\\zephyr","setup_cmd":""},{"platform":"macos","os":"macos-15","xvfb":"","zephyr_base":"/tmp/zephyr","setup_cmd":""}]}'
          UBUNTU_ONLY='{"include":[{"platform":"ubuntu","os":"ubuntu-latest","xvfb":"xvfb-run -a ","zephyr_base":"/tmp/zephyr","setup_cmd":"sudo apt-get update && sudo apt-get install -y xvfb libgtk-3-0 libgbm1 libnss3 libasound2t64"}]}'

          if [ "${{ github.event_name }}" = "push" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Running all platforms (push to release branch or manual dispatch)"
            echo "matrix=$ALL_PLATFORMS" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ contains(github.event.pull_request.labels.*.name, 'test-all-platforms') }}" = "true" ]; then
            echo "Running all platforms (test-all-platforms label detected)"
            echo "matrix=$ALL_PLATFORMS" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "pull_request" ] && ([ "${{ github.event.pull_request.base.ref }}" = "main" ] || [ "${{ github.event.pull_request.base.ref }}" = "pre-release" ]); then
            echo "Running all platforms (PR targets main or pre-release)"
            echo "matrix=$ALL_PLATFORMS" >> "$GITHUB_OUTPUT"
          else
            echo "Running Ubuntu only (default PR test)"
            echo "matrix=$UBUNTU_ONLY" >> "$GITHUB_OUTPUT"
          fi

  # Stage 2: Build VSIX on Ubuntu
  build-vsix:
    needs: determine-platforms
    runs-on: ubuntu-latest
    outputs:
      vsix_name: ${{ steps.package.outputs.vsix_name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Extension
        run: npm run vscode:prepublish

      - name: Get version info
        id: version_info
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_HASH=$(git rev-parse --short=6 HEAD)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "commit_hash=${COMMIT_HASH}" >> "$GITHUB_OUTPUT"

      - name: Package Extension
        id: package
        run: |
          VSIX_NAME="zephyr-ide-${{ steps.version_info.outputs.version }}-${{ steps.version_info.outputs.commit_hash }}.vsix"
          npx vsce package --out "$VSIX_NAME"
          echo "vsix_name=${VSIX_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package
          path: "*.vsix"
          retention-days: 7

  # Stage 3: Platform Integration Tests
  # Platform matrix is determined dynamically based on trigger type and labels
  test-platforms:
    needs: [determine-platforms, build-vsix]
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.determine-platforms.outputs.matrix) }}

    runs-on: ${{ matrix.os }}
    name: test-${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}

      # Windows runners: move TEMP/TMP to the D: drive which has significantly
      # more free space than C:.  SDK downloads, 7z extraction, venv creation,
      # and other temp-heavy operations will use this path automatically.
      - name: Set TEMP to D drive
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path 'D:\Temp'
          echo 'TEMP=D:\Temp' >> $env:GITHUB_ENV
          echo 'TMP=D:\Temp' >> $env:GITHUB_ENV
        shell: pwsh

      # 7-Zip is pre-installed on GitHub Windows runners but its directory
      # is not always on PATH.  Adding it here via GITHUB_PATH ensures it
      # is available when the VS Code extension host process spawns, so
      # west/sdk operations that shell out to 7z work immediately.
      # (refreshWindowsPath() now preserves process-level PATH entries,
      # so this won't be clobbered.)
      - name: Add 7-Zip to PATH
        if: runner.os == 'Windows'
        run: echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH
        shell: pwsh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Download VSIX
        uses: actions/download-artifact@v4.1.3
        with:
          name: vsix-package
          path: ./vsix

      - name: Install system dependencies
        if: matrix.setup_cmd != ''
        run: ${{ matrix.setup_cmd }}

      - name: Install npm dependencies
        run: npm ci

      - name: Compile TypeScript
        run: npm run test-compile

      - name: Bundle Extension (dist)
        run: npm run esbuild

      # Single test run that performs all 3 steps sequentially in same process
      # This solves the Windows PATH propagation issue by running everything
      # in a single VS Code instance where PATH refresh is effective
      - name: "Run Combined Test (All Steps in Same Process)"
        run: |
          ${{ matrix.xvfb }}node scripts/run-integration-tests.js combined
        env:
          NODE_ENV: test
          ZEPHYR_BASE: ${{ matrix.zephyr_base }}
          VSIX_PATH: ./vsix/${{ needs.build-vsix.outputs.vsix_name }}
        timeout-minutes: 30
