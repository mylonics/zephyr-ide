name: Build VSIX from Branch

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build VSIX from'
        required: true
        type: string
        default: 'main'

permissions:
  contents: read

jobs:
  build-vsix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build Extension
        run: npm run vscode:prepublish

      - name: Get version and commit hash
        id: version_info
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_HASH=$(git rev-parse --short=6 HEAD)
          BRANCH_NAME="${{ inputs.branch }}"
          # Sanitize branch name for filename (replace special chars with -, limit to 30 chars)
          SAFE_BRANCH=$(echo "${BRANCH_NAME}" | sed 's/[^a-zA-Z0-9-]/-/g' | cut -c1-30)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "commit_hash=${COMMIT_HASH}" >> "$GITHUB_OUTPUT"
          echo "safe_branch=${SAFE_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "Package version: ${VERSION}-${SAFE_BRANCH}-${COMMIT_HASH}"

      - name: Package Extension
        run: npx vsce package --out zephyr-ide-${{ steps.version_info.outputs.version }}-${{ steps.version_info.outputs.safe_branch }}-${{ steps.version_info.outputs.commit_hash }}.vsix

      - name: Upload VSIX Artifact
        uses: actions/upload-artifact@v4
        with:
          name: zephyr-ide-${{ steps.version_info.outputs.version }}-${{ steps.version_info.outputs.safe_branch }}-${{ steps.version_info.outputs.commit_hash }}
          path: "*.vsix"
          retention-days: 90
